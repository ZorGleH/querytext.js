var querytext=function(d){var r=function(a){return a.replace(/\u00c6/gm,"AE").replace(/[\u00c1\u00c2\u00c0\u00c5\u00c3\u00c4]/gm,"A").replace(/\u00c7/gm,"C").replace(/[\u00c9\u00ca\u00c8\u00cb]/gm,"E").replace(/[\u00cd\u00ce\u00cc\u00cf]/gm,"I").replace(/\u00d1/gm,"N").replace(/\u0152/gm,"OE").replace(/[\u00d3\u00d4\u00d2\u00d8\u00d5\u00d6]/gm,"O").replace(/[\u00da\u00db\u00d9\u00dc]/gm,"U").replace(/\u00dd/gm,"Y").replace(/\u00e6/gm,"ae").replace(/[\u00e1\u00e2\u00e0\u00e5\u00e3\u00e4]/gm,"a").replace(/\u00e7/gm,"c").replace(/[\u00e9\u00ea\u00e8\u00eb]/gm,"e").replace(/[\u00ed\u00ee\u00ec\u00ef]/gm,"i").replace(/\u00f1/gm,"n").replace(/\u0153/gm,"oe").replace(/[\u00f3\u00f4\u00f2\u00f8\u00f5\u00f6]/gm,"o").replace(/[\u00fa\u00fb\u00f9\u00fc]/gm,"u").replace(/[\u00fd\u00ff]/gm,"y")},j={VERSION:0.3,opts:{dftbool:"OR",sensitive:!1,wholeword:!0,unaccent:!0,matches:!1,debug:!1},error:!1,query:!1,tree:!1,parse:function(a){var q=function(a,g,m){g||(g=0);for(var b=0,k=!1,f=!1,e=a.length,c,l,n,h,d,p,j=function(a,
b){k&&(a.not=!0,f||(f="AND"),k=!1);if(a.text){var c=a.text.replace(/(^\s+|\s+$)/gm,""),e="*"==c[0]||!m.wholeword?"":"(^|\\W:?)",g="*"==c.substr(-1)||!m.wholeword?"":"($|\\W:?)",c=c.replace(/(^\*|\*$)/g,""),c=c.replace(/([\(\)\+\*\?\:\[\]])/g,"\\$1"),c=c.replace(/\s+/g,"\\s+");a.rex=RegExp(e+c+g,"m"+(m.sensitive?"":"i")+(m.matches?"g":""))}b&&(a.src=b);p?(f||(f=m.dftbool),f===p.bool&&k===(p.not||!1)?p.subs.push(a):p={bool:f,subs:[p,a]}):p=a;f=!1};b<e;)if('"'==a[b]){c=b++;for(h="";b<e&&'"'!=a[b];)h+=
a[b++];if(b>=e)return{error:"unbalanced quotes",pos:c+g};j({text:h});b++}else{if(")"==a[b])return{error:"unbalanced parenthesis",pos:c+g};if("("==a[b]){c=b++;d=1;for(h="";b<e&&!(")"==a[b]&&0==--d);){"("==a[b]&&d++;h+=a[b];if('"'==a[b]){for(n=b++;b<e&&'"'!=a[b];)h+=a[b++];h+=a[b];if(b>=e)return{error:"unbalanced quotes",pos:n+g}}b++}if(b>=e)return{error:"unbalanced parenthesis",pos:c+g};n=q(h,c+1,m);if(n.error)return n;j(n,h);b++}else if(" ">=a[b])for(;b<e&&" ">=a[b];)b++;else if("+"==a[b]){if(k||
f)return{error:"unexpected operator",pos:b+g};f="AND";l=b++}else if("|"==a[b]){if(k||f)return{error:"unexpected operator",pos:b+g};f="OR";l=b++}else if("-"==a[b]||"!"==a[b])k=!k,l=b++;else{c=b;for(h="";b<e&&" "<a[b]&&!/[\(\)\+\-\|\!]/.test(a[b]);)h+=a[b++];if(/^(AND|OR|NOT|NEAR\d)$/i.test(h))if(l=c,n=RegExp.$1.toUpperCase(),"NOT"==n)k=!k;else{if(k||f)return{error:"unexpected operator",pos:c+g};f=n}else j({text:h})}}return k||f?{error:"unexpected operator",pos:l+g}:p?p:{error:"empty query",pos:g}};
this.error=this.tree=!1;this.query=this.opts.unaccent?r(a):a;a=q(this.query,0,this.opts);delete this.pos;a.error?(this.error=a.error,this.pos=a.pos,this.opts.debug&&console.log(a.error,"at",a.pos)):(this.tree=a,this.opts.debug&&console.log(this.dump()));return this},dump:function(a,q){if(!this.tree)return"";a||(a=this.tree);q||(q="");var d=a.not?"NOT ":"",g=a.src?" : "+d+"("+a.src+")":"",m=void 0!=a.match?" = "+a.match:"";self=this;return a.bool?q+d+a.bool+m+g+"\n"+a.subs.map(function(a){return self.dump(a,
q+" | ")}).join("\n"):q+d+'"'+a.text+'"'+m},normalize:function(a){a||(a=this.tree);if(!a)return"";var d=a.not?"NOT ":"",j=[],g=this;return a.bool?(a.subs.forEach(function(a){j.push(g.normalize(a))}),d||a!=this.tree?d+"("+j.join(" "+a.bool+" ")+")":j.join(" "+a.bool+" ")):/\s/.test(a.text)||/^(and|or|not)$/i.test(a.text)||/[\(\)\+\-\!\?\|]/.test(a.text)?d+'"'+a.text+'"':d+a.text},match:function(a){if(!this.tree)return!1;var d=this,j=function(a){delete a.match;a.bool&&a.subs.forEach(function(a){j(a)})},
g=function(a,k,f){var e,c,l,j;if(a.bool)if("AND"==a.bool){e=!0;for(c=0;c<a.subs.length&&e;++c)e=g(a.subs[c],k,f)}else{e=!1;for(c=0;c<a.subs.length&&(!(e=g(a.subs[c],k,f)||e)||f);++c);}else if(!1!==f&&!a.not)for(e=!1;null!=(c=a.rex.exec(k));)e=!0,l=c[0],c=c.index,d.opts.sensitive||(l=l.toLowerCase()),d.opts.wholeword&&(j=l.length,l=l.replace(/^\W+|\W+$/g,""),c+=j-l.length),void 0==f[l]&&(f[l]=[]),f[l].push(c);else e=a.rex.test(k);a.not&&(e=!e);return a.match=e},m=this.opts.matches?{}:!1;j(this.tree);
a=g(this.tree,this.opts.unaccent?r(a):a,m);this.opts.debug&&(console.log(this.dump()),m&&console.log(m));return this.opts.matches&&a?m:a}};d&&("string"==typeof d?j.parse(d):"object"==typeof d&&(["debug","sensitive","wholeword","unaccent","matches"].forEach(function(a){void 0!==d[a]&&(j.opts[a]=d[a])}),d.query&&j.parse(d.query)));return j};