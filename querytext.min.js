// querytext.js 1.0 (c) 2012-2014 niko 
// https://github.com/nikopol/querytext.js
var querytext=function(q){var x=function(a){return a.replace(/[\u00c1\u00c2\u00c0\u00c5\u00c3\u00c4]/gm,"A").replace(/\u00c7/gm,"C").replace(/[\u00c9\u00ca\u00c8\u00cb]/gm,"E").replace(/[\u00cd\u00ce\u00cc\u00cf]/gm,"I").replace(/\u00d1/gm,"N").replace(/[\u00d3\u00d4\u00d2\u00d8\u00d5\u00d6]/gm,"O").replace(/[\u00da\u00db\u00d9\u00dc]/gm,"U").replace(/\u00dd/gm,"Y").replace(/[\u00e1\u00e2\u00e0\u00e5\u00e3\u00e4]/gm,"a").replace(/\u00e7/gm,"c").replace(/[\u00e9\u00ea\u00e8\u00eb]/gm,"e").replace(/[\u00ed\u00ee\u00ec\u00ef]/gm,"i").replace(/\u00f1/gm,"n").replace(/[\u00f3\u00f4\u00f2\u00f8\u00f5\u00f6]/gm,"o").replace(/[\u00fa\u00fb\u00f9\u00fc]/gm,"u").replace(/[\u00fd\u00ff]/gm,"y")},y=function(a,h,g,d){var e=[];a.forEach(function(b){var a=!1,g=b.ofs;b=b.txt.length;var d=g+b-1,c;for(c in e)g>=e[c].p&&g<=e[c].e?(d>e[c].e&&(e[c].e=d,e[c].l=1+d-e[c].p),a=!0):d>=e[c].p&&d<=e[c].e?(e[c].p=g,e[c].l=1+e[c].e-g,a=!0):g<e[c].p&&d>e[c].e&&(e[c].p=g,e[c].e=d,e[c].l=b,a=!0);a||e.push({p:g,l:b,e:d})});e.sort(function(b,a){return a.p-
b.p}).forEach(function(b){h=h.substr(0,b.p)+g+h.substr(b.p,b.l)+d+h.substr(b.p+b.l)});return h},t={VERSION:0.8,opts:{dftbool:"OR",sensitive:!1,wholeword:!0,unaccent:!0,matches:!1,debug:!1,wordpos:!1},error:!1,query:!1,tree:!1,parse:function(a){var h=function(a,d,e){d||(d=0);for(var b=0,n=!1,m=!1,l=a.length,c,p,k,f,v,r,s,z=function(a){a=a.replace(/(^\s+|\s+$)/gm,"");var b="*"!=a[0]&&e.wholeword?"(^|[\\s,;:\\-+=<>\\\\\\/'\"\\(\\)~&\\[\\]{}\u300b\u300a\uff0c]:?)":"",d="*"!=a.substr(-1)&&e.wholeword?
"($|[\\s,;:\\-+=<>\\\\\\/'\"\\(\\)~&\\[\\]{}\u300b\u300a\uff0c]:?)":"";a=a.replace(/(^\*|\*$)/g,"");a=a.replace(/([\(\)\+\*\?\:\[\]])/g,"\\$1");a=a.replace(/\s+/g,"\\s+");return RegExp(b+a+d,"m"+(e.sensitive?"":"i")+(e.matches?"g":""))},u=function(a,b){n&&(a.not=!0,m||(m="AND"),n=!1);a.text&&(a.rex=z(a.text));b&&(a.src=b);s?(m||(m=e.dftbool),m===s.bool&&n===(s.not||!1)?s.subs.push(a):s={bool:m,subs:[s,a]}):s=a;m=!1};b<l;)if('"'==a[b]){c=b++;for(f="";b<l&&'"'!=a[b];)f+=a[b++];if(b>=l)return{error:"unbalanced quotes",
pos:c+d};if(!f.length||"*"==f)return{error:"empty quotes",pos:c+d};b++;if(b<l&&"~"==a[b]){b++;for(k="";b<l&&"0"<=a[b]&&"9">=a[b];)k+=a[b++];if(!k.length)return{error:"proximity distance missing",pos:c+d};k=parseInt(k,10);if(50<k)return{error:"proximity distance too big",pos:c+d};r={bool:"NEAR",dist:k,subs:[]};f.split(/\s+/).forEach(function(a){r.subs.push({text:a,rex:z(a)})});u(r);e.wordpos=e.matches=!0}else u({text:f})}else{if(")"==a[b])return{error:"unbalanced parenthesis",pos:c+d};if("("==a[b]){c=
b++;v=1;for(f="";b<l&&(")"!=a[b]||0!=--v);){"("==a[b]&&v++;f+=a[b];if('"'==a[b]){for(k=b++;b<l&&'"'!=a[b];)f+=a[b++];f+=a[b];if(b>=l)return{error:"unbalanced quotes",pos:k+d}}b++}if(b>=l)return{error:"unbalanced parenthesis",pos:c+d};r=h(f,c+1,e);if(r.error)return r;u(r,f);b++}else if(" ">=a[b])for(;b<l&&" ">=a[b];)b++;else if("+"==a[b]){if(n||m)return{error:"unexpected operator",pos:b+d};m="AND";p=b++}else if("|"==a[b]){if(n||m)return{error:"unexpected operator",pos:b+d};m="OR";p=b++}else if("-"==
a[b]||"!"==a[b])n=!n,p=b++;else{c=b;for(f="";b<l&&" "<a[b]&&!/[\(\)\+\-\|\!\"]/.test(a[b]);)f+=a[b++];if(/^(AND|OR|NOT)$/i.test(f))if(p=c,r=RegExp.$1.toUpperCase(),"NOT"==r)n=!n;else{if(n||m)return{error:"unexpected operator",pos:c+d};m=r}else{if("*"==f)return{error:"empty word",pos:c+d};u({text:f})}}}return n||m?{error:"unexpected operator",pos:p+d}:s?s:{error:"empty query",pos:d}};this.error=this.tree=!1;this.query=this.opts.unaccent?x(a):a;a=h(this.query,0,this.opts);delete this.pos;a.error?(this.error=
a.error,this.pos=a.pos,this.opts.debug&&console.log(a.error,"at",a.pos)):(this.tree=a,this.opts.debug&&console.log(this.dump()));return this},dump:function(a,h){if(!this.tree)return"";a||(a=this.tree);h||(h="");var g=a.not?"NOT ":"",d=a.src?" : "+g+"("+a.src+")":"",e=void 0!=a.dist?"("+a.dist+") ":"",b=void 0!=a.match?" = "+a.match:"";self=this;return a.bool?h+g+a.bool+e+b+d+"\n"+a.subs.map(function(a){return self.dump(a,h+" | ")}).join("\n"):h+g+'"'+a.text+'"'+b},normalize:function(a){a||(a=this.tree);
if(!a)return"";var h=a.not?"NOT ":"",g=[],d=this,e;if(a.bool){if("NEAR"==a.bool)return e=a.subs.map(function(a){return a.text}).join(" "),h+'"'+e+'"~'+a.dist;a.subs.forEach(function(a){g.push(d.normalize(a))});return h||a!=this.tree?h+"("+g.join(" "+a.bool+" ")+")":g.join(" "+a.bool+" ")}return/^(and|or|not)$/i.test(a.text)||/[\s\(\)\+\-\!\?\|]/.test(a.text)?h+'"'+a.text+'"':h+a.text},match:function(a){if(!this.tree)return!1;var h=this,g=this.opts.matches?[]:!1,d=this.opts.wordpos?{}:!1,e=function(a){delete a.match;
delete a.pos;a.bool&&a.subs.forEach(function(a){e(a)})},b=function(a){if(void 0==d[a]){for(var b=0;b<d.length&&d[b]<a;)b++;return 0<b?d[b-1]:0}return d[a]},n=function(a,b){var d,e=Number.MAX_VALUE;b.pos.forEach(function(b){d=Math.abs(b.pos-a);d<e&&(e=d)});return e},m=function(a,e){var c,f,l,k,p,q;if(a.bool)if("NEAR"==a.bool){c=!0;q=a.subs.length;for(f=0;f<q&&c;++f)c=m(a.subs[f],e);if(c)for(f=0;f<q&&c;++f)c=a.subs[f],c.pos=c.pos.filter(function(b){for(l=0;l<q;++l)if(l!=f&&n(b.pos,a.subs[l])<=a.dist)return!0;
return!1}),c=c.pos.length}else if("AND"==a.bool)for(c=!0,f=0;f<a.subs.length&&c;++f)c=m(a.subs[f],e);else for(c=!1,f=0;f<a.subs.length&&(!(c=m(a.subs[f],e)||c)||g);++f);else if(g&&!a.not)for(c=!1,a.pos=[];null!=(f=a.rex.exec(e));)c=!0,k=f[0],p=f.index,h.opts.sensitive||(k=k.toLowerCase()),h.opts.wholeword&&(q=k.length,k=k.replace(/^[\s,;:\-+=<>\\\/'"\(\)~&\[\]{}\u300b\u300a\uff0c]+/g,""),p+=q-k.length,k=k.replace(/[\s,;:\-+=<>\\\/'"\(\)~&\[\]{}\u300b\u300a\uff0c]+$/g,""),1<q&&a.rex.lastIndex--),p=
{txt:k,ofs:p},d&&(p.pos=b(p.ofs)),a.pos.push(p);else c=a.rex.test(e);a.not&&(c=!c);return a.match=c},l=function(a){a.bool?a.subs.forEach(function(a){l(a)}):a.pos&&a.pos.forEach(function(a){g.push(a)});return g};if(d)for(var c=0,p=0,k=a.length,f=/^[\-0-9A-Za-z\u00C0-\u017F]+$/;c<k;)if("."==a[c])p+=100,c++;else if(f.test(a[c]))for(d[c]=p++;++c<k&&f.test(a[c]););else for(;++c<k&&"."!=a[c]&&!f.test(a[c]););e(this.tree);a=m(this.tree,this.opts.unaccent?x(a):a);this.opts.debug&&console.log(this.dump());
return a&&g?l(this.tree):a},highlightml:function(a,h,g){if(!this.tree)return a;if(!this.opts.matches)return!1;for(var d=a.innerHTML,e="",b=0,n=!1;b<d.length;)n||(n="<"==d[b]),n?(n=">"!=d[b],e+=" "):e+=d[b],b++;a.innerHTML=y(this.match(e),d,h,g);return a},highlight:function(a,h,g,d){return"object"==typeof a?this.highlightml(a,h,g):d?(d=document.createElement("div"),d.innerHTML=a,this.highlightml(d,h,g).innerHTML):this.tree?this.opts.matches?y(this.match(a),a,h,g):!1:a}};if(q)if("string"==typeof q)t.parse(q);
else if("object"==typeof q){for(var w in t.opts)void 0!==q[w]&&(t.opts[w]=q[w]);q.query&&t.parse(q.query)}return t};