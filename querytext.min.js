var querytext=function(d){var s=function(a){return a.replace(/\u00c6/gm,"AE").replace(/[\u00c1\u00c2\u00c0\u00c5\u00c3\u00c4]/gm,"A").replace(/\u00c7/gm,"C").replace(/[\u00c9\u00ca\u00c8\u00cb]/gm,"E").replace(/[\u00cd\u00ce\u00cc\u00cf]/gm,"I").replace(/\u00d1/gm,"N").replace(/\u0152/gm,"OE").replace(/[\u00d3\u00d4\u00d2\u00d8\u00d5\u00d6]/gm,"O").replace(/[\u00da\u00db\u00d9\u00dc]/gm,"U").replace(/\u00dd/gm,"Y").replace(/\u00e6/gm,"ae").replace(/[\u00e1\u00e2\u00e0\u00e5\u00e3\u00e4]/gm,"a").replace(/\u00e7/gm,"c").replace(/[\u00e9\u00ea\u00e8\u00eb]/gm,"e").replace(/[\u00ed\u00ee\u00ec\u00ef]/gm,"i").replace(/\u00f1/gm,"n").replace(/\u0153/gm,"oe").replace(/[\u00f3\u00f4\u00f2\u00f8\u00f5\u00f6]/gm,"o").replace(/[\u00fa\u00fb\u00f9\u00fc]/gm,"u").replace(/[\u00fd\u00ff]/gm,"y")},p={VERSION:0.4,opts:{dftbool:"OR",sensitive:!1,wholeword:!0,unaccent:!0,matches:!1,debug:!1},error:!1,query:!1,tree:!1,parse:function(a){var n=function(a,e,h){e||(e=0);for(var b=0,m=!1,g=!1,f=a.length,c,k,q,l,d,r,p=function(a,
b){m&&(a.not=!0,g||(g="AND"),m=!1);if(a.text){var c=a.text.replace(/(^\s+|\s+$)/gm,""),e="*"!=c[0]&&h.wholeword?"(^|\\W:?)":"",f="*"!=c.substr(-1)&&h.wholeword?"($|\\W:?)":"",c=c.replace(/(^\*|\*$)/g,""),c=c.replace(/([\(\)\+\*\?\:\[\]])/g,"\\$1"),c=c.replace(/\s+/g,"\\s+");a.rex=RegExp(e+c+f,"m"+(h.sensitive?"":"i")+(h.matches?"g":""))}b&&(a.src=b);r?(g||(g=h.dftbool),g===r.bool&&m===(r.not||!1)?r.subs.push(a):r={bool:g,subs:[r,a]}):r=a;g=!1};b<f;)if('"'==a[b]){c=b++;for(l="";b<f&&'"'!=a[b];)l+=
a[b++];if(b>=f)return{error:"unbalanced quotes",pos:c+e};p({text:l});b++}else{if(")"==a[b])return{error:"unbalanced parenthesis",pos:c+e};if("("==a[b]){c=b++;d=1;for(l="";b<f&&(")"!=a[b]||0!=--d);){"("==a[b]&&d++;l+=a[b];if('"'==a[b]){for(q=b++;b<f&&'"'!=a[b];)l+=a[b++];l+=a[b];if(b>=f)return{error:"unbalanced quotes",pos:q+e}}b++}if(b>=f)return{error:"unbalanced parenthesis",pos:c+e};q=n(l,c+1,h);if(q.error)return q;p(q,l);b++}else if(" ">=a[b])for(;b<f&&" ">=a[b];)b++;else if("+"==a[b]){if(m||g)return{error:"unexpected operator",
pos:b+e};g="AND";k=b++}else if("|"==a[b]){if(m||g)return{error:"unexpected operator",pos:b+e};g="OR";k=b++}else if("-"==a[b]||"!"==a[b])m=!m,k=b++;else{c=b;for(l="";b<f&&" "<a[b]&&!/[\(\)\+\-\|\!]/.test(a[b]);)l+=a[b++];if(/^(AND|OR|NOT|NEAR\d)$/i.test(l))if(k=c,q=RegExp.$1.toUpperCase(),"NOT"==q)m=!m;else{if(m||g)return{error:"unexpected operator",pos:c+e};g=q}else p({text:l})}}return m||g?{error:"unexpected operator",pos:k+e}:r?r:{error:"empty query",pos:e}};this.error=this.tree=!1;this.query=this.opts.unaccent?
s(a):a;a=n(this.query,0,this.opts);delete this.pos;a.error?(this.error=a.error,this.pos=a.pos,this.opts.debug&&console.log(a.error,"at",a.pos)):(this.tree=a,this.opts.debug&&console.log(this.dump()));return this},dump:function(a,n){if(!this.tree)return"";a||(a=this.tree);n||(n="");var d=a.not?"NOT ":"",e=a.src?" : "+d+"("+a.src+")":"",h=void 0!=a.match?" = "+a.match:"";self=this;return a.bool?n+d+a.bool+h+e+"\n"+a.subs.map(function(a){return self.dump(a,n+" | ")}).join("\n"):n+d+'"'+a.text+'"'+h},
normalize:function(a){a||(a=this.tree);if(!a)return"";var n=a.not?"NOT ":"",d=[],e=this;return a.bool?(a.subs.forEach(function(a){d.push(e.normalize(a))}),n||a!=this.tree?n+"("+d.join(" "+a.bool+" ")+")":d.join(" "+a.bool+" ")):/^(and|or|not)$/i.test(a.text)||/[\s\(\)\+\-\!\?\|]/.test(a.text)?n+'"'+a.text+'"':n+a.text},match:function(a){if(!this.tree)return!1;var d=this,p=function(a){delete a.match;a.bool&&a.subs.forEach(function(a){p(a)})},e=function(a,m,g){var f,c,k,h;if(a.bool)if("AND"==a.bool)for(f=
!0,c=0;c<a.subs.length&&f;++c)f=e(a.subs[c],m,g);else for(f=!1,c=0;c<a.subs.length&&(!(f=e(a.subs[c],m,g)||f)||g);++c);else if(!1===g||a.not)f=a.rex.test(m);else for(f=!1;null!=(c=a.rex.exec(m));)f=!0,k=c[0],c=c.index,d.opts.sensitive||(k=k.toLowerCase()),d.opts.wholeword&&(h=k.length,k=k.replace(/^\W+/g,""),c+=h-k.length,k=k.replace(/\W+$/g,"")),void 0==g[k]&&(g[k]=[]),g[k].push(c);a.not&&(f=!f);return a.match=f},h=this.opts.matches?{}:!1;p(this.tree);a=e(this.tree,this.opts.unaccent?s(a):a,h);this.opts.debug&&
(console.log(this.dump()),h&&console.log(h));return this.opts.matches&&a?h:a},highlight:function(a,d,p){if(!this.tree)return a;if(!this.opts.matches)return!1;var e=this.match(a),h=[],b;for(b in e)e[b].forEach(function(a){h.push([a,b.length])});h.sort(function(a,b){return b[0]>a[0]}).forEach(function(b){a=a.substr(0,b[0])+d+a.substr(b[0],b[1])+p+a.substr(b[0]+b[1])});return a}};d&&("string"==typeof d?p.parse(d):"object"==typeof d&&(["debug","sensitive","wholeword","unaccent","matches"].forEach(function(a){void 0!==
d[a]&&(p.opts[a]=d[a])}),d.query&&p.parse(d.query)));return p};