var querytext=function(d){var r=function(a){return a.replace(/\u00c6/gm,"AE").replace(/[\u00c1\u00c2\u00c0\u00c5\u00c3\u00c4]/gm,"A").replace(/\u00c7/gm,"C").replace(/[\u00c9\u00ca\u00c8\u00cb]/gm,"E").replace(/[\u00cd\u00ce\u00cc\u00cf]/gm,"I").replace(/\u00d1/gm,"N").replace(/\u0152/gm,"OE").replace(/[\u00d3\u00d4\u00d2\u00d8\u00d5\u00d6]/gm,"O").replace(/[\u00da\u00db\u00d9\u00dc]/gm,"U").replace(/\u00dd/gm,"Y").replace(/\u00e6/gm,"ae").replace(/[\u00e1\u00e2\u00e0\u00e5\u00e3\u00e4]/gm,"a").replace(/\u00e7/gm,"c").replace(/[\u00e9\u00ea\u00e8\u00eb]/gm,"e").replace(/[\u00ed\u00ee\u00ec\u00ef]/gm,"i").replace(/\u00f1/gm,"n").replace(/\u0153/gm,"oe").replace(/[\u00f3\u00f4\u00f2\u00f8\u00f5\u00f6]/gm,"o").replace(/[\u00fa\u00fb\u00f9\u00fc]/gm,"u").replace(/[\u00fd\u00ff]/gm,"y")},n={VERSION:0.3,opts:{dftbool:"OR",sensitive:!1,wholeword:!0,unaccent:!0,matches:!1,debug:!1},error:!1,query:!1,tree:!1,parse:function(a){var m=function(a,e,h){e||(e=0);for(var b=0,l=!1,g=!1,f=a.length,c,j,p,k,d,q,n=function(a,
b){l&&(a.not=!0,g||(g="AND"),l=!1);if(a.text){var c=a.text.replace(/(^\s+|\s+$)/gm,""),e="*"==c[0]||!h.wholeword?"":"(^|\\W:?)",f="*"==c.substr(-1)||!h.wholeword?"":"($|\\W:?)",c=c.replace(/(^\*|\*$)/g,""),c=c.replace(/([\(\)\+\*\?\:\[\]])/g,"\\$1"),c=c.replace(/\s+/g,"\\s+");a.rex=RegExp(e+c+f,"m"+(h.sensitive?"":"i")+(h.matches?"g":""))}b&&(a.src=b);q?(g||(g=h.dftbool),g===q.bool&&l===(q.not||!1)?q.subs.push(a):q={bool:g,subs:[q,a]}):q=a;g=!1};b<f;)if('"'==a[b]){c=b++;for(k="";b<f&&'"'!=a[b];)k+=
a[b++];if(b>=f)return{error:"unbalanced quotes",pos:c+e};n({text:k});b++}else{if(")"==a[b])return{error:"unbalanced parenthesis",pos:c+e};if("("==a[b]){c=b++;d=1;for(k="";b<f&&!(")"==a[b]&&0==--d);){"("==a[b]&&d++;k+=a[b];if('"'==a[b]){for(p=b++;b<f&&'"'!=a[b];)k+=a[b++];k+=a[b];if(b>=f)return{error:"unbalanced quotes",pos:p+e}}b++}if(b>=f)return{error:"unbalanced parenthesis",pos:c+e};p=m(k,c+1,h);if(p.error)return p;n(p,k);b++}else if(" ">=a[b])for(;b<f&&" ">=a[b];)b++;else if("+"==a[b]){if(l||
g)return{error:"unexpected operator",pos:b+e};g="AND";j=b++}else if("|"==a[b]){if(l||g)return{error:"unexpected operator",pos:b+e};g="OR";j=b++}else if("-"==a[b]||"!"==a[b])l=!l,j=b++;else{c=b;for(k="";b<f&&" "<a[b]&&!/[\(\)\+\-\|\!]/.test(a[b]);)k+=a[b++];if(/^(AND|OR|NOT|NEAR\d)$/i.test(k))if(j=c,p=RegExp.$1.toUpperCase(),"NOT"==p)l=!l;else{if(l||g)return{error:"unexpected operator",pos:c+e};g=p}else n({text:k})}}return l||g?{error:"unexpected operator",pos:j+e}:q?q:{error:"empty query",pos:e}};
this.error=this.tree=!1;this.query=this.opts.unaccent?r(a):a;a=m(this.query,0,this.opts);delete this.pos;a.error?(this.error=a.error,this.pos=a.pos,this.opts.debug&&console.log(a.error,"at",a.pos)):(this.tree=a,this.opts.debug&&console.log(this.dump()));return this},dump:function(a,m){if(!this.tree)return"";a||(a=this.tree);m||(m="");var d=a.not?"NOT ":"",e=a.src?" : "+d+"("+a.src+")":"",h=void 0!=a.match?" = "+a.match:"";self=this;return a.bool?m+d+a.bool+h+e+"\n"+a.subs.map(function(a){return self.dump(a,
m+" | ")}).join("\n"):m+d+'"'+a.text+'"'+h},normalize:function(a){a||(a=this.tree);if(!a)return"";var m=a.not?"NOT ":"",d=[],e=this;return a.bool?(a.subs.forEach(function(a){d.push(e.normalize(a))}),m||a!=this.tree?m+"("+d.join(" "+a.bool+" ")+")":d.join(" "+a.bool+" ")):/^(and|or|not)$/i.test(a.text)||/[\s\(\)\+\-\!\?\|]/.test(a.text)?m+'"'+a.text+'"':m+a.text},match:function(a){if(!this.tree)return!1;var d=this,n=function(a){delete a.match;a.bool&&a.subs.forEach(function(a){n(a)})},e=function(a,
l,g){var f,c,j,h;if(a.bool)if("AND"==a.bool){f=!0;for(c=0;c<a.subs.length&&f;++c)f=e(a.subs[c],l,g)}else{f=!1;for(c=0;c<a.subs.length&&(!(f=e(a.subs[c],l,g)||f)||g);++c);}else if(!1!==g&&!a.not)for(f=!1;null!=(c=a.rex.exec(l));)f=!0,j=c[0],c=c.index,d.opts.sensitive||(j=j.toLowerCase()),d.opts.wholeword&&(h=j.length,j=j.replace(/^\W+/g,""),c+=h-j.length,j=j.replace(/\W+$/g,"")),void 0==g[j]&&(g[j]=[]),g[j].push(c);else f=a.rex.test(l);a.not&&(f=!f);return a.match=f},h=this.opts.matches?{}:!1;n(this.tree);
a=e(this.tree,this.opts.unaccent?r(a):a,h);this.opts.debug&&(console.log(this.dump()),h&&console.log(h));return this.opts.matches&&a?h:a},highlight:function(a,d,n){if(!this.tree)return a;this.opts.matches=!0;var e=this.match(a),h=[],b;for(b in e)e[b].forEach(function(a){h.push([a,b.length])});h.sort(function(a,b){return b[0]>a[0]}).forEach(function(b){a=a.substr(0,b[0])+d+a.substr(b[0],b[1])+n+a.substr(b[0]+b[1])});return a}};d&&("string"==typeof d?n.parse(d):"object"==typeof d&&(["debug","sensitive",
"wholeword","unaccent","matches"].forEach(function(a){void 0!==d[a]&&(n.opts[a]=d[a])}),d.query&&n.parse(d.query)));return n};