// querytext.js 0.9 (c) 2012-2013 niko 
// https://github.com/nikopol/querytext.js
var querytext=function(p){var u=function(a){return a.replace(/[\u00c1\u00c2\u00c0\u00c5\u00c3\u00c4]/gm,"A").replace(/\u00c7/gm,"C").replace(/[\u00c9\u00ca\u00c8\u00cb]/gm,"E").replace(/[\u00cd\u00ce\u00cc\u00cf]/gm,"I").replace(/\u00d1/gm,"N").replace(/[\u00d3\u00d4\u00d2\u00d8\u00d5\u00d6]/gm,"O").replace(/[\u00da\u00db\u00d9\u00dc]/gm,"U").replace(/\u00dd/gm,"Y").replace(/[\u00e1\u00e2\u00e0\u00e5\u00e3\u00e4]/gm,"a").replace(/\u00e7/gm,"c").replace(/[\u00e9\u00ea\u00e8\u00eb]/gm,"e").replace(/[\u00ed\u00ee\u00ec\u00ef]/gm,"i").replace(/\u00f1/gm,"n").replace(/[\u00f3\u00f4\u00f2\u00f8\u00f5\u00f6]/gm,"o").replace(/[\u00fa\u00fb\u00f9\u00fc]/gm,"u").replace(/[\u00fd\u00ff]/gm,"y")},v=function(a,l,n,c){var e,b,d,h,k,f,q,g=[];for(e in a)for(b in a[e]){f=!1;h=a[e][b];q=e.length;k=h+q-1;for(d in g)h>=g[d].p&&h<=g[d].e?(k>g[d].e&&(g[d].e=k,g[d].l=1+k-g[d].p),f=!0):k>=g[d].p&&k<=g[d].e?(g[d].p=h,g[d].l=1+g[d].e-h,f=!0):h<g[d].p&&k>g[d].e&&(g[d].p=h,g[d].e=k,g[d].l=q,f=!0);f||g.push({p:h,l:q,e:k})}g.sort(function(b,a){return a.p-
b.p}).forEach(function(b){l=l.substr(0,b.p)+n+l.substr(b.p,b.l)+c+l.substr(b.p+b.l)});return l},s={VERSION:0.8,opts:{dftbool:"OR",sensitive:!1,wholeword:!0,unaccent:!0,matches:!1,debug:!1},error:!1,query:!1,tree:!1,parse:function(a){var l=function(a,c,e){c||(c=0);for(var b=0,d=!1,h=!1,k=a.length,f,q,g,m,p,r,s=function(a,b){d&&(a.not=!0,h||(h="AND"),d=!1);if(a.text){var c=a.text.replace(/(^\s+|\s+$)/gm,""),f="*"!=c[0]&&e.wholeword?"(^|[\\s,;:\\-+=<>\\\\\\/'\"\\(\\)~&\\[\\]{}\u300b\u300a\uff0c]:?)":
"",g="*"!=c.substr(-1)&&e.wholeword?"($|[\\s,;:\\-+=<>\\\\\\/'\"\\(\\)~&\\[\\]{}\u300b\u300a\uff0c]:?)":"",c=c.replace(/(^\*|\*$)/g,""),c=c.replace(/([\(\)\+\*\?\:\[\]])/g,"\\$1"),c=c.replace(/\s+/g,"\\s+");a.rex=RegExp(f+c+g,"m"+(e.sensitive?"":"i")+(e.matches?"g":""))}b&&(a.src=b);r?(h||(h=e.dftbool),h===r.bool&&d===(r.not||!1)?r.subs.push(a):r={bool:h,subs:[r,a]}):r=a;h=!1};b<k;)if('"'==a[b]){f=b++;for(m="";b<k&&'"'!=a[b];)m+=a[b++];if(b>=k)return{error:"unbalanced quotes",pos:f+c};if(!m.length||
"*"==m)return{error:"empty quotes",pos:f+c};s({text:m});b++}else{if(")"==a[b])return{error:"unbalanced parenthesis",pos:f+c};if("("==a[b]){f=b++;p=1;for(m="";b<k&&(")"!=a[b]||0!=--p);){"("==a[b]&&p++;m+=a[b];if('"'==a[b]){for(g=b++;b<k&&'"'!=a[b];)m+=a[b++];m+=a[b];if(b>=k)return{error:"unbalanced quotes",pos:g+c}}b++}if(b>=k)return{error:"unbalanced parenthesis",pos:f+c};g=l(m,f+1,e);if(g.error)return g;s(g,m);b++}else if(" ">=a[b])for(;b<k&&" ">=a[b];)b++;else if("+"==a[b]){if(d||h)return{error:"unexpected operator",
pos:b+c};h="AND";q=b++}else if("|"==a[b]){if(d||h)return{error:"unexpected operator",pos:b+c};h="OR";q=b++}else if("-"==a[b]||"!"==a[b])d=!d,q=b++;else{f=b;for(m="";b<k&&" "<a[b]&&!/[\(\)\+\-\|\!\"]/.test(a[b]);)m+=a[b++];if(/^(AND|OR|NOT|NEAR\d)$/i.test(m))if(q=f,g=RegExp.$1.toUpperCase(),"NOT"==g)d=!d;else{if(d||h)return{error:"unexpected operator",pos:f+c};h=g}else{if("*"==m)return{error:"empty word",pos:f+c};s({text:m})}}}return d||h?{error:"unexpected operator",pos:q+c}:r?r:{error:"empty query",
pos:c}};this.error=this.tree=!1;this.query=this.opts.unaccent?u(a):a;a=l(this.query,0,this.opts);delete this.pos;a.error?(this.error=a.error,this.pos=a.pos,this.opts.debug&&console.log(a.error,"at",a.pos)):(this.tree=a,this.opts.debug&&console.log(this.dump()));return this},dump:function(a,l){if(!this.tree)return"";a||(a=this.tree);l||(l="");var n=a.not?"NOT ":"",c=a.src?" : "+n+"("+a.src+")":"",e=void 0!=a.match?" = "+a.match:"";self=this;return a.bool?l+n+a.bool+e+c+"\n"+a.subs.map(function(a){return self.dump(a,
l+" | ")}).join("\n"):l+n+'"'+a.text+'"'+e},normalize:function(a){a||(a=this.tree);if(!a)return"";var l=a.not?"NOT ":"",n=[],c=this;return a.bool?(a.subs.forEach(function(a){n.push(c.normalize(a))}),l||a!=this.tree?l+"("+n.join(" "+a.bool+" ")+")":n.join(" "+a.bool+" ")):/^(and|or|not)$/i.test(a.text)||/[\s\(\)\+\-\!\?\|]/.test(a.text)?l+'"'+a.text+'"':l+a.text},match:function(a){if(!this.tree)return!1;var l=this,n=function(a){delete a.match;a.bool&&a.subs.forEach(function(a){n(a)})},c=function(a,
d,h){var k,f,e,g;if(a.bool)if("AND"==a.bool)for(k=!0,f=0;f<a.subs.length&&k;++f)k=c(a.subs[f],d,h);else for(k=!1,f=0;f<a.subs.length&&(!(k=c(a.subs[f],d,h)||k)||h);++f);else if(!1===h||a.not)k=a.rex.test(d);else for(k=!1;null!=(f=a.rex.exec(d));)k=!0,e=f[0],f=f.index,l.opts.sensitive||(e=e.toLowerCase()),l.opts.wholeword&&(g=e.length,e=e.replace(/^[\s,;:\-+=<>\\\/'"\(\)~&\[\]{}\u300b\u300a\uff0c]+/g,""),f+=g-e.length,e=e.replace(/[\s,;:\-+=<>\\\/'"\(\)~&\[\]{}\u300b\u300a\uff0c]+$/g,""),1<g&&a.rex.lastIndex--),
void 0==h[e]&&(h[e]=[]),h[e].push(f);a.not&&(k=!k);return a.match=k},e=this.opts.matches?{}:!1;n(this.tree);a=c(this.tree,this.opts.unaccent?u(a):a,e);this.opts.debug&&(console.log(this.dump()),e&&console.log(e));return this.opts.matches&&a?e:a},highlightml:function(a,l,n){if(!this.tree)return a;if(!this.opts.matches)return!1;var c=a.innerHTML,e="",b,d;b=0;for(d=!1;b<c.length;++b)d||(d="<"==c[b]),d?(d=">"!=c[b],e+=" "):e+=c[b];a.innerHTML=v(this.match(e),c,l,n);return a},highlight:function(a,l,n,
c){return"object"==typeof a?this.highlightml(a,l,n):c?(c=document.createElement("div"),c.innerHTML=a,this.highlightml(c,l,n).innerHTML):this.tree?this.opts.matches?v(this.match(a),a,l,n):!1:a}};if(p)if("string"==typeof p)s.parse(p);else if("object"==typeof p){for(var t in s.opts)void 0!==p[t]&&(s.opts[t]=p[t]);p.query&&s.parse(p.query)}return s};